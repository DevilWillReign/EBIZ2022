FROM golang:1.18-buster

ARG ARG_FRONT_HOST=http://localhost:9001
ARG ARG_API_PORT=9000
ARG ARG_API_HOST_CALLBACK
ARG ARG_SESSION_SECRET
ARG ARG_JWT_SECRET
ARG ARG_GOOGLE_OAUTH_CLIENT_ID
ARG ARG_GOOGLE_OAUTH_CLIENT_SECRET
ARG ARG_GH_OAUTH_CLIENT_ID
ARG ARG_GH_OAUTH_CLIENT_SECRET
ARG ARG_GL_OAUTH_CLIENT_ID
ARG ARG_GL_OAUTH_CLIENT_SECRET

ENV FRONT_HOST $ARG_FRONT_HOST
ENV API_HOST_CALLBACK $ARG_API_HOST_CALLBACK
ENV API_PORT $ARG_API_PORT
ENV SESSION_SECRET $ARG_SESSION_SECRET
ENV JWT_SECRET $ARG_JWT_SECRET
ENV GOOGLE_OAUTH_CLIENT_ID $ARG_GOOGLE_OAUTH_CLIENT_ID
ENV GOOGLE_OAUTH_CLIENT_SECRET $ARG_GOOGLE_OAUTH_CLIENT_SECRET
ENV GH_OAUTH_CLIENT_ID $ARG_GH_OAUTH_CLIENT_ID
ENV GH_OAUTH_CLIENT_SECRET $ARG_GH_OAUTH_CLIENT_SECRET
ENV GL_OAUTH_CLIENT_ID $ARG_GL_OAUTH_CLIENT_ID
ENV GL_OAUTH_CLIENT_SECRET $ARG_GL_OAUTH_CLIENT_SECRET
ENV PROFILE "PROD"

RUN useradd -m -s /bin/bash appuser
USER appuser
WORKDIR /home/appuser

COPY go.mod ./
COPY go.sum ./

RUN go mod download

COPY . .

RUN go build -o appritstoreback

EXPOSE ${API_PORT}

CMD [ "./appritstoreback" ]
